# Сервис защиты операций с помощью OTP-кода
## Описание сервиса

Backend-приложение, которое ориентировано на защиту операций с помощью временных кодов. Основная цель сервиса — обеспечить безопасность при выполнении различных действий, требующих подтверждения.

---


## Требования к программному обеспечению

Для корректной работы и тестирования сервиса необходимо наличие следующего установленного
и настроенного программного обеспечения:

* Docker;
* Gradle;
* OpenJDK 17+;
* Программа командной строки ***curl*** или ПО Postman для тестирования API;
* Среда разработки IntelliJ IDEA (Community или Ultimate);
* Система контроля версий Git;
* DBeaver или pgAdmin для просмотра сущностей в базе данных;
* Настроенный эмулятор SMTP-сервера для отправки Email-сообщений на сайте https://ethereal.email/ ;
* Настроенный эмулятор для эмуляции отправки SMS-сообщений по протоколу SMPP https://github.com/delhee/SMPPSim/releases/tag/3.0.0 ;
* Настроенный Telegram-бот и тестовый чат для эмуляции отправки сообщений.

---


## Запуск необходимой инфраструктуры

1. Первоначально необходимо склонировать репозиторий сервиса с помощью команды:
```bash
git clone https://github.com/euchekavelo/personal-finance-management-service.git
```
2. Затем перейти в корневую директорию проекта и запустить docker-контейнер с БД PostgreSQL командой:
```bash
docker-compose up -d
```
3. Открыть и запустить склонированный проект, используя IntelliJ IDEA.
<br>
**ВАЖНО:** Перед запуском проекта в файле ***application.yml*** обязательно скорректировать настройки для подключения
к эмуляторам настроенного SMTP-сервера (префикс **spring.mail**), а также эмулятора SMPP-протокола для отправки SMS (префикс **smpp**).
<br>
Также необходимо установить опции локального окружения **TELEGRAM_BOT_TOKEN** и **TELEGRAM_CHAT_ID** с указанием собственного токена бота и тестового чата.

---


## Инструкция по использованию
Сервис представляет из себя бэкенд-приложения, функциональность которого заключается в использовании REST API, отвечающего за ключевые операции.
<br>Ниже представлены некоторые примеры таких операций с использованием программы командной строки ***curl***.

---

### Регистрация пользователя
Пример команды:
```bash
curl --location --request POST 'localhost:8080/auth/registration' \
--header 'Content-Type: application/json' \
--data-raw '{
    "login": "test3@mail.ru",
    "password": "test3",
    "phoneNumber": "+1111111113",
    "role": "ROLE_USER"
}'
```
**Примечание**
<br>
Данный эндпоинт производит регистрацию пользователя с установкой определенной роли.
<br>
**Важно:** пользователю возможно установить единственную роль **ROLE_USER** или **ROLE_ADMIN**.

---


### Авторизовать пользователя в системе с помощью логина и пароля
Пример команды:
```bash
curl --location --request POST 'localhost:8080/auth/login' \
--header 'Content-Type: application/json' \
--data-raw '{
    "login": "test3@mail.ru",
    "password": "test3"
}'
```
**Примечание**
<br>
Данный эндпоинт производит аутентификацию и авторизацию пользователя в системе. 
<br>
В качестве ответа возвращается токен (срок действия 30 минут) для последующей работы с REST API.

---


### Установить конфигурацию для последующей генерации OTP-кодов
Пример команды:
```bash
curl --location --request POST 'localhost:8080/otp-codes/configuration' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer <значение токена доступа>' \
--data '{
    "lifeTimeInMilliseconds": 60000,
    "length": 6
}'
```
**Примечание**
<br>
Данный эндпоинт производит установку конфигурационных настроек (время жизни в миллисекундах и длина) для последующей генерации OTP-кодов.
<br>
**ВАЖНО:** Данный эндпоинт доступен лишь пользователю с ролью ROLE_ADMIN.

---


### Сгенерировать и отправить OTP-код
Пример команды:
```bash
curl --location --request POST 'localhost:8080/otp-codes' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer <значение токена доступа>' \
--data '{
    "sendType": "SMS",
    "operationId": 1
}'
```
**Примечание**
<br>
Данный эндпоинт производит генерацию и отправку OTP-кода для указанного идентификатора операции по установленному способу отправки из под авторизованного пользователя.
<br>
Доступен один из способов для отправки OTP-кода (значения свойства **sendType**): **SMS**, **TELEGRAM**, **EMAIL**.


#### Некоторые примеры генерации OTP-кодов для операции и отправки с помощью указанных способов
Пример отправки в виде SMS в эмулятор:
![](screenshots/Пример%20отправки%20SMS.png)

Пример отправки в виде почтового email-сообщения в почтовый эмулятор:
![](screenshots/Пример%20отправки%20EMAIL.png)

Пример отправки в виде telegram-сообщения в чат бота:
![](screenshots/Пример%20отправки%20в%20TELEGRAM.png)

---


### Валидация OTP-кода
Пример команды:
```bash
curl --location --request POST 'localhost:8080/otp-codes/validation' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer <значение токена доступа>' \
--data '{
    "otpCode": 51178,
    "operationId": 2
}'
```
**Примечание**
<br>
Данный эндпоинт производит проверку на валидность OTP-кода для указанной операции из под авторизованного пользователя.

---


### Получение списка всех пользователей кроме администратора
Пример команды:
```bash
curl --location --request GET 'localhost:8080/users' \
--header 'Authorization: Bearer <значение токена доступа>'
```
**Примечание**
<br>
Данный эндпоинт возвращает информацию о всех пользователях, исключая администратора.
<br>
**Важно:** Данный эндпоинт доступен лишь пользователю с ролью **ROLE_ADMIN**.

---


### Удаление всех пользователей, исключая администратора, и их OTP-кодов
Пример команды:
```bash
curl --location --request GET 'localhost:8080/users' \
--header 'Authorization: Bearer <значение токена доступа>'
```
**Примечание**
<br>
Данный эндпоинт производит удаление всех пользователей, исключая пользователя с ролью **ROLE_ADMIN**, и их OTP-кодов.
<br>
**Важно:** Данный эндпоинт доступен лишь пользователю с ролью **ROLE_ADMIN**.

---


### Удаление конкретного пользователя, исключая администратора, и его OTP-кодов
Пример команды:
```bash
curl --location --request DELETE 'localhost:8080/users/4' \
--header 'Authorization: Bearer <значение токена доступа>'
```
**Примечание**
<br>
Данный эндпоинт производит удаление конкретного пользователя, исключая авторизованного пользователя с ролью **ROLE_ADMIN**, и его OTP-кодов.
<br>
**Важно:** Данный эндпоинт доступен лишь пользователю с ролью **ROLE_ADMIN**.

---


### Автоматическая актуализация OTP-кодов
Дополнительно в сервисе реализован функционал по переводу истекших OTP-кодов в статус **EXPIRED**.
<br>
Данная функция отрабатывает автоматически каждые 5 секунд (этот параметр можно скорректировать под собственное расписание).

---


### Фиксация сгенерированных OTP-кодов в файле
Дополнительно в сервисе присутствует функционал по реестровой фиксации сгенерированных и отправленных каким-либо способом OTP-кодов пользователей.
Данный файл располагается в корневой директории проекта ***logs/app.log***.

---